<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
	<script type="text/javascript" src="//api.map.baidu.com/api?v=3.0&ak=BmTwezCvWyGaH3KNYkc5P6uq"></script>
	<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.4/css/bootstrap-select.min.css">
	<link rel="stylesheet" type="text/css" href="../css/laydate.css" />
	<link rel="stylesheet" href="../style/jquery.dataTables.min.css">
	<link rel="stylesheet" type="text/css" href="../css/layui.css" />
	<link rel="stylesheet" type="text/css" href="../css/layui.mobile.css" />
	<style type="text/css">
		body, html, #container {
			width: 100%;
			height: 100%;
			overflow: hidden;
			margin: 0;
			font-family: "微软雅黑";
		}
		a {
			cursor:pointer;
			text-decoration:none
		}
		/*设置 tbody高度大于400px时 出现滚动条*/
		table tbody {
			display: block;
			height: 180px;
			overflow-y: scroll;
		}
		table thead, tbody tr {
			display: table;
			width: 100%;
			table-layout: fixed;
		}
		/*滚动条默认宽度是16px 将thead的宽度减16px*/
		table thead {
			width: calc( 100% - 1em);
		}

	</style>
</head>
<body>

<!--<div id="container"></div>-->
<div class="container-fluid">
	<div class="row-fluid">
		<div class="span12">
			<div class="row-fluid">
				<div class="span12">

					<div id="container" style="height: 60vh;"></div>
				</div>
			</div>
			<div class="row-fluid">
				<div class="span12">
					<div class="zhuti-content">
						<div class="LowerPart">
							<table class=" table table-bordered table-condensed table-hover layui-table" lay-skin="line" id="mainContent" style="width: 1800px;white-space: nowrap;">
								<thead>
								<tr style="background-color:#EBF4FF;border-bottom:none;background-image:none;">
									<th>序号</th>
									<th>车牌</th>
									<th style="width: 500px;">开始时间</th>
									<th style="width: 200px;">结束时间</th>
									<th>速度(km/h)</th>
									<th>开始里程(km)</th>
									<th>结束里程(km)</th>
									<th>本次行程的持续里程(km)</th>
									<th>本次行程的持续时间(s)</th>
									<th>开始经纬度</th>
									<th>结束经纬度</th>

								</tr>
								</thead>
								<tbody>
								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
</body>

</html>
<script src="https://cdn.staticfile.org/jquery/3.2.1/jquery.js"></script>
<script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.0/js/bootstrap.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.4/js/bootstrap-select.min.js"></script>
<script src="../toastr/toastr.js"></script>
<script src="../js/laydate/laydate.js"></script>
<script src="../js/getDayScope.js"></script>
<script src="../js/jquery.dataTables.min.js"></script>
<script src="../js/layui.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/element.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript">

	$(document).ready(function () {
		laydate.render({
			elem: '#starTime', //指定元素
			type: 'datetime',trigger: 'click'
		});
		laydate.render({
			elem: '#endTime', //指定元素
			type: 'datetime',trigger: 'click'
		});



	});
	let table = $('#mainContent').DataTable({
		"deferRender": true,
		"processing": true,
		"bDestroy": true,
		"iDisplayLength": 10,
		"searching": false,
		"lengthChange": false,
		"oLanguage": {
			"sSearch": '<span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span>'
		},
		"columns": [
			{"data": null},
			{"data": "plate"},
			{"data": "beginTime"},
			{"data": "endTime"},
			{"data": "speed"},
			{"data": "mileageBegin"},
			{"data": "mileageEnd"},
			{"data": "thisMileage"},
			{"data": "thisSecs"},
			{"data": "lonBegin"},
			{"data": "lonEnd"},
			/*{"data": "latBegin"},
			{"data": "latEnd"},*/
		],
		"columnDefs": [
			{
				"class": "tcenter",
				"targets": 9,
				"searchable": false,
				"render": function(data, type, full) {
					return data+","+full.latBegin;
				}
			},{
				"class": "tcenter",
				"targets": 10,
				"searchable": false,
				"render": function(data, type, full) {
					return data+","+full.latEnd;
				}
			},
		], "fnDrawCallback": function () {
			this.api().column(0).nodes().each(function(cell, i){
				cell.innerHTML=i+1;
			});
		},
		//让表格出横向滚动条 ，此时 表头和 表中数据将分为两个部分
		"sScrollX":true,
		// 让表格的宽度不自适应 ，固定宽度。 如果不设置 表头和表中数据会分离
		//表中的数据自适应 ，表头的宽度固定
		"bAutoWidth":false,
		"order": [[2, 'desc']],
		"oLanguage": { //国际化配置
			"sProcessing": "正在获取数据，请稍后...",
			"sLengthMenu": "显示 _MENU_ 条",
			"sZeroRecords": "查询不到相关数据",
			"sInfo": "从 _START_ 到  _END_ 条记录 总记录数为 _TOTAL_ 条",
			"sInfoEmpty": "记录数为0",
			"sInfoFiltered": "(全部记录数 _MAX_ 条)",
			"sInfoPostFix": "",
			"sSearch": "搜索",
			"sUrl": "",
			"oPaginate": {
				"sFirst": "第一页",
				"sPrevious": "上一页",
				"sNext": "下一页",
				"sLast": "最后一页"
			}
		}

	});

	//行点击事件
	$('#mainContent tbody').on('click','tr', function (e) {
		var data = table.row( this ).data();
		var point = new BMap.Point(data.lonEnd, data.latEnd);
		map.centerAndZoom(point, 15);

		var marker = new BMap.Marker(point);  // 创建标注
		map.addOverlay(marker);              // 将标注添加到地图中
		var opts = {
			width : 200,     // 信息窗口宽度
			height: 120,     // 信息窗口高度
			title : "指定车辆里程数据" , // 信息窗口标题
			message:"这里是故宫"
		}
		var infoWindow = new BMap.InfoWindow(
				"<div class='amap-info-content amap-info-outer'>车牌："+data.plate+"<br>开始时间："+data.beginTime+"<br>结束时间："+data.endTime+"<br>速度："+data.speed+"Km/h<br>里程："+data.thisMileage+"km/h<br><a class='amap-info-close' href='javascript: void(0)' style='right: 5px;'>×</a></div>", opts);  // 创建信息窗口对象
			map.openInfoWindow(infoWindow, point); //开启信息窗口
		/*marker.addEventListener("click", function(){
		});*/
	} );

	var key="f30da8ee-61da-4c1a-bd73-54fee1d19d69";
	function initChePai(){
		$.ajax({
	// get请求地址
			url: "http://58.222.201.158:6809/deviceData/vehicleBaseInfo.do?key="+key,
			dataType: "json",
			success: function (data) {

				for (var i = 0; i < data.obj.length; i++) {
					$('.selectpicker').append("<option value=" + data.obj[i].id + ">" + data.obj[i].plate + "</option>");
				}

				$('#suggestId').selectpicker({
					'selectedText': 'cat',
					'noneSelectedText': '请选择',
					'deselectAllText': '全不选',
					'selectAllText': '全选'
				});
				// 缺一不可
				$('#suggestId').selectpicker('refresh');
				$('#suggestId').selectpicker('render');

			}
		});
	}

	function search(){
		var chepaipID=$('#suggestId').val().toString();
		let starthaomiao = getHaomiao($("#starTime").val());
		let endTimehaomiao = getHaomiao($("#endTime").val());
		if(chepaipID!=""&&chepaipID!=undefined&&chepaipID!=null&&$("#starTime").val()!=null&&$("#starTime").val()!=""&&$("#starTime").val()!=undefined
				&&$("#endTime").val()!=null&&$("#endTime").val()!=""&&$("#endTime").val()!=undefined){
			getlicheng(chepaipID,starthaomiao,endTimehaomiao)
		}else{
			toastr.error("请选择车牌和时间")
			alert("请选择车牌和时间")
		}
	}

	function getlicheng(chepaipID,starthaomiao,endTimehaomiao){
		$.ajax({
			// get请求地址
			url: "http://58.222.201.158:6809/mileage/mileageData.do?key="+key+"&startTime="+starthaomiao+"&endTime="+endTimehaomiao+"&id="+chepaipID,
			dataType: "json",
			success: function (data) {
				if(data.flag==1){
					setDiTu(data.obj);
					$('#mainContent').dataTable().fnClearTable();
					$('#mainContent').DataTable().rows.add(data.obj).draw(false);
				}else{
					toastr.error(data.msg)
				}
			}
		});
	}

	function setDiTu(data){

		//起点-途经点-终点
		if(data!=null&&data.length!=0){
			console.log(data)
			/**/
			for(var i=0;i<data.length;i++){
				var start = new BMap.Point(data[i].lonBegin,data[i].latBegin);
				var end = new BMap.Point(data[i].lonEnd,data[i].latEnd);
				var driving = new BMap.DrivingRoute(map, {renderOptions:{map: map, autoViewport: true}
					});
				driving.search(start, end);
			}

		}

	}



	let map = new BMap.Map("container"); // 创建Map实例,GL版命名空间为BMapGL(鼠标右键控制倾斜角度)
	map.centerAndZoom(new BMap.Point(116.404, 39.915), 14);      // 初始化地图,设置中心点坐标和地图级别
	map.enableScrollWheelZoom(true);


	// 百度地图API功能
	function G(id) {
		return document.getElementById(id);
	}

	/*var map = new BMap.Map("l-map");
	map.centerAndZoom(new BMap.Point(120.714537, 30.122469), 9);*/              // 初始化地图,设置城市和地图级别。

	// 定义一个控件类,即function
	function ZoomControl() {
		this.defaultAnchor = BMAP_ANCHOR_TOP_LEFT;
		this.defaultOffset = new BMap.Size(10, 10);
	}

	// 通过JavaScript的prototype属性继承于BMap.Control
	ZoomControl.prototype = new BMap.Control();

	// 自定义控件必须实现自己的initialize方法,并且将控件的DOM元素返回
	// 在本方法中创建个p元素作为控件的容器,并将其添加到地图容器中
	ZoomControl.prototype.initialize = function(map){
		// 创建一个DOM元素
		var p = document.createElement("p");
		p.innerHTML = '<div style="width: 250px;background-color: white;box-shadow:grey 0px 0px 5px">' +
				'<p id="r-result">车辆筛选:<!--<input type="text" id="suggestId" size="20" value="百度" placeholder="支持搜索" style="width:150px;" />-->' +
				'<select class="form-control selectpicker" multiple data-max-options="1" data-actions-box="false"' +
				'data-live-search="true"  id="suggestId"   style="width:80%;"></select></p>' +
				'<div class="ivu-col ivu-col-span-8">选择时间：</div>' +
				' <div class="ivu-col ivu-col-span-16"><!--<a onclick="getDay(0)">今天</a>--> <a onclick="getDay(-1)">昨天</a> <a onclick="getDay(-3)">近三天</a> <a onclick="getDay(-7)">近七天</a></div>'+
				'<div class="ivu-col ivu-col-span-7">开始时间：</div>' +
				' <div class="ivu-col ivu-col-span-17">' +
				'<input type="text" autocomplete="off" id="starTime" placeholder="选择日期时间" ></div>' +
				'<div class="ivu-col ivu-col-span-7">结束时间：</div>' +
				' <div class="ivu-col ivu-col-span-17">' +
				'<input type="text" autocomplete="off" id="endTime" placeholder="选择日期时间" ></div>' +
				'<button type="button" onclick="search()" class="search-btn-track ivu-btn ivu-btn-primary ivu-btn-small"> <span>查找</span></button></div>';



		initChePai()
		// 添加DOM元素到地图中
		map.getContainer().appendChild(p);
		// 将DOM元素返回
		return p;


	}

	// 创建控件
	var myZoomCtrl = new ZoomControl();
	// 添加到地图当中
	map.addControl(myZoomCtrl);






	/*var ac = new BMap.Autocomplete(    //建立一个自动完成的对象
			{"input" : "suggestId"
				,"location" : map
			});

	ac.addEventListener("onhighlight", function(e) {  //鼠标放在下拉列表上的事件
		var str = "";
		var _value = e.fromitem.value;
		var value = "";
		if (e.fromitem.index > -1) {
			value = _value.province +  _value.city +  _value.district +  _value.street +  _value.business;
		}
		str = "FromItem<br />index = " + e.fromitem.index + "<br />value = " + value;

		value = "";
		if (e.toitem.index > -1) {
			_value = e.toitem.value;
			value = _value.province +  _value.city +  _value.district +  _value.street +  _value.business;
		}
		str += "<br />ToItem<br />index = " + e.toitem.index + "<br />value = " + value;
		G("searchResultPanel").innerHTML = str;


	});

	var myValue;
	ac.addEventListener("onconfirm", function(e) {    //鼠标点击下拉列表后的事件
		var _value = e.item.value;
		myValue = _value.province +  _value.city +  _value.district +  _value.street +  _value.business;
		G("searchResultPanel").innerHTML ="onconfirm<br />index = " + e.item.index + "<br />myValue = " + myValue;

		setPlace();
	});

	function setPlace(){
		map.clearOverlays();    //清除地图上所有覆盖物
		function myFun(){
			var pp = local.getResults().getPoi(0).point;    //获取第一个智能搜索的结果
			map.centerAndZoom(pp, 14);
			console.log('pp',pp)
			map.addOverlay(new BMap.Marker(pp));    //添加标注
		}
		var local = new BMap.LocalSearch(map, { //智能搜索
			onSearchComplete: myFun
		});
		local.search(myValue);
	}*/
</script>
