<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
	<script type="text/javascript" src="//api.map.baidu.com/api?v=2.0&ak=BmTwezCvWyGaH3KNYkc5P6uq"></script>
	<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.4/css/bootstrap-select.min.css">
	<link rel="stylesheet" type="text/css" href="../css/laydate.css" />
	<link rel="stylesheet" href="../style/jquery.dataTables.min.css">
	<link rel="stylesheet" type="text/css" href="../css/layui.css" />
	<link rel="stylesheet" type="text/css" href="../css/layui.mobile.css" />
	<style type="text/css">
		body, html, #container {
			width: 100%;
			height: 100%;
			overflow: hidden;
			margin: 0;
			font-family: "微软雅黑";
		}
		a {
			cursor:pointer;
			text-decoration:none
		}
		/*设置 tbody高度大于400px时 出现滚动条*/
		table tbody {
			display: block;
			height: 180px;
			overflow-y: scroll;
		}
		table thead, tbody tr {
			display: table;
			width: 100%;
			table-layout: fixed;
		}
		/*滚动条默认宽度是16px 将thead的宽度减16px*/
		table thead {
			width: calc( 100% - 1em);
		}
        .ceng{
             background-color: white;
             border-radius:10px;
             width: 350px;
             height: 320px;
             position: absolute;
             z-index: 1;
             box-shadow: 10px 10px 10px #818181;
             left: 5%;
             margin-top: 1%;
        }
        .layui-btn+.layui-btn{
            margin-left:0px;
        }
	</style>
</head>
<body>

<!--<div id="container"></div>-->
<div class="container-fluid">
	<div class="row-fluid">
		<div class="span12">
			<div class="row-fluid">
				<div class="span12">

					<div id="container" style="height: 60vh;"></div>
				</div>
			</div>
			<div class="row-fluid">
				<div class="span12">
					<div class="zhuti-content">
						<div class="LowerPart">
							<table class=" table table-bordered table-condensed table-hover layui-table" lay-skin="line" id="mainContent" style="width: 3200px;">
								<thead>
								<tr style="background-color:#EBF4FF;border-bottom:none;background-image:none;">
									<th>序号</th>
									<th>车牌</th>
									<th style="width: 500px;">时间</th>
									<th>是否补传数据</th>
									<th>方向</th>
									<th>里程(m)</th>
									<th>Acc状态</th>
									<th>速度(km/h)</th>
									<th>定位状态</th>
									<th>停车时长(ms)</th>
									<th>行停状态</th>
									<th>油量</th>
									<th>传感器速度</th>
									<th>温度</th>
									<th>报警</th>
									<th>刻度(电阻)</th>
									<th>扩展数据</th>
									<th>近光灯信号</th>
									<th>远光灯信号</th>
									<th>右转向灯信号</th>
									<th>左转向灯信号</th>
									<th>制动信号</th>
									<th>倒挡信号</th>
									<th>喇叭信号</th>
									<th>空调信号</th>
									<th>正反转状态</th>
									<th>经纬度</th>

								</tr>
								</thead>
								<tbody>
								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
</body>

</html>
<script src="https://cdn.staticfile.org/jquery/3.2.1/jquery.js"></script>
<script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.0/js/bootstrap.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.4/js/bootstrap-select.min.js"></script>
<script src="../toastr/toastr.js"></script>
<script src="../js/laydate/laydate.js"></script>
<script src="../js/getDayScope.js"></script>
<script src="../js/jquery.dataTables.min.js"></script>
<script src="../js/layui.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/element.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript">

	$(document).ready(function () {
		laydate.render({
			elem: '#starTime', //指定元素
			type: 'datetime',trigger: 'click'
		});
		laydate.render({
			elem: '#endTime', //指定元素
			type: 'datetime',trigger: 'click'
		});



	});
	let table = $('#mainContent').DataTable({
		"deferRender": true,
		"processing": true,
		"bDestroy": true,
		"iDisplayLength": 10,
		"searching": false,
		"lengthChange": false,
		"oLanguage": {
			"sSearch": '<span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span>'
		},
		"columns": [
			{"data": null},
			{"data": "plate"},
			{"data": "devTime"},
			{"data": "isRealTime"},
			{"data": "direct"},
			{"data": "mileage"},
			{"data": "isAcc"},
			{"data": "speed"},
			{"data": "isPos"},
			{"data": "stopTime"},
			{"data": "stopState"},
			{"data": "oil"},
			{"data": "sensorSpeed"},
			{"data": "temperature"},
			{"data": "alarm"},
			{"data": "scale"},
			{"data": "extend"},
			{"data": "lbSignal"},
			{"data": "hbSignal"},
			{"data": "rtlSignal"},
			{"data": "ltlSignal"},
			{"data": "brakeSignal"},
			{"data": "RSignal"},
			{"data": "hornSignal"},
			{"data": "acSignal"},
			{"data": "turnDir"},
			{"data": "lon"},
		],
		"columnDefs": [
			{
				"class": "tcenter",
				"targets": 1,
				"searchable": false,
				"render": function(data, type, full) {
					return   $('#suggestId').find('option:selected')[0].textContent.toString();
				}
			},{
				"class": "tcenter",
				"targets": 3,
				"searchable": false,
				"render": function(data, type, full) {
					if(data==0){
						return "实时数据"
					}else if(data==1){
						return "补传数据"
					}else return ''
				}
			},{
				"class": "tcenter",
				"targets": 6,
				"searchable": false,
				"render": function(data, type, full) {
					if(data==0){
						return "开启"
					}else if(data==1){
						return "关闭"
					}else if(data==2){
						return "不解析"
					}else return ''
				}
			},{
				"class": "tcenter",
				"targets": 8,
				"searchable": false,
				"render": function(data, type, full) {
					if(data==0){
						return "不定位"
					}else if(data==1){
						return "定位"
					}else  return ''
				}
			},{
				"class": "tcenter",
				"targets": 10,
				"searchable": false,
				"render": function(data, type, full) {
					if(data==1){
						return "行"
					}else if(data==2){
						return "停"
					}else if(data==3){
						return "离线"
					}else  return ''
				}
			},{
				"class": "tcenter",
				"targets": 16,
				"searchable": false,
				"render": function(data, type, full) {
					if(data.lbSignal==undefined||data.lbSignal==null||data.lbSignal==""){
						return ""
					}else  return data
				}
			},{
				"class": "tcenter",
				"targets": 17,
				"searchable": false,
				"render": function(data, type, full) {
					if(data==1){
						return "开启近光灯"
					}else  return '关闭近光灯'
				}
			},{
				"class": "tcenter",
				"targets": 18,
				"searchable": false,
				"render": function(data, type, full) {
					if(data==1){
						return "开启远光灯"
					}else  return '关闭远光灯'
				}
			},{
				"class": "tcenter",
				"targets": 19,
				"searchable": false,
				"render": function(data, type, full) {
					if(data==1){
						return "开启右转向灯"
					}else  return '关闭右转向灯'
				}
			},{
				"class": "tcenter",
				"targets": 20,
				"searchable": false,
				"render": function(data, type, full) {
					if(data==1){
						return "开启左转向灯"
					}else  return '关闭左转向灯'
				}
			},{
				"class": "tcenter",
				"targets": 21,
				"searchable": false,
				"render": function(data, type, full) {
					if(data==1){
						return "开启制动信号"
					}else  return '关闭制动信号'
				}
			},{
				"class": "tcenter",
				"targets": 22,
				"searchable": false,
				"render": function(data, type, full) {
					if(data==1){
						return "开启倒挡信号"
					}else  return '关闭倒挡信号'
				}
			},{
				"class": "tcenter",
				"targets": 23,
				"searchable": false,
				"render": function(data, type, full) {
					if(data==1){
						return "开启喇叭信号"
					}else  return '关闭喇叭信号'
				}
			},{
				"class": "tcenter",
				"targets": 24,
				"searchable": false,
				"render": function(data, type, full) {
					if(data==1){
						return "开启空调信号"
					}else  return '关闭空调信号'
				}
			},{
				"class": "tcenter",
				"targets": 25,
				"searchable": false,
				"render": function(data, type, full) {
					if(data==1){
						return "正转"
					}else if(data==0){
						return "反转"
					}else if(data==-1){
						return "无正反转状态"
					}else return ''
				}
			},
			{
				"class": "tcenter",
				"targets": 26,
				"searchable": false,
				"render": function(data, type, full) {
					return data+","+full.lat;
				}
			}
		], "fnDrawCallback": function () {
			this.api().column(0).nodes().each(function(cell, i){
				cell.innerHTML=i+1;
			});
		},
		//让表格出横向滚动条 ，此时 表头和 表中数据将分为两个部分
		"sScrollX":true,
		// 让表格的宽度不自适应 ，固定宽度。 如果不设置 表头和表中数据会分离
		//表中的数据自适应 ，表头的宽度固定
		"bAutoWidth":false,
		"order": [[2, 'desc']],
		"oLanguage": { //国际化配置
			"sProcessing": "正在获取数据，请稍后...",
			"sLengthMenu": "显示 _MENU_ 条",
			"sZeroRecords": "查询不到相关数据",
			"sInfo": "从 _START_ 到  _END_ 条记录 总记录数为 _TOTAL_ 条",
			"sInfoEmpty": "记录数为0",
			"sInfoFiltered": "(全部记录数 _MAX_ 条)",
			"sInfoPostFix": "",
			"sSearch": "搜索",
			"sUrl": "",
			"oPaginate": {
				"sFirst": "第一页",
				"sPrevious": "上一页",
				"sNext": "下一页",
				"sLast": "最后一页"
			}
		}

	});

	//行点击事件
	$('#mainContent tbody').on('click','tr', function (e) {
		var name = $(this).text()
		var data = table.row( this ).data();
		var point = new BMap.Point(data.lon, data.lat);
		map.centerAndZoom(point, 14);

		var marker = new BMap.Marker(point);  // 创建标注
		map.addOverlay(marker);              // 将标注添加到地图中
		var opts = {
			width : 250,     // 信息窗口宽度
			height: 100,     // 信息窗口高度
			title : "指定车辆里程数据" , // 信息窗口标题
			message:"这里是故宫"
		}
		var infoWindow = new BMap.InfoWindow(
				"<div class='amap-info-content amap-info-outer'>车牌："+($('#suggestId').find('option:selected')[0].textContent.toString())+"<br>时间："+data.devTime+"<br>速度："+data.speed+"Km/h<br>里程："+data.mileage+"m<br><a class='amap-info-close' href='javascript: void(0)' style='right: 5px;'>×</a></div>", opts);  // 创建信息窗口对象

		map.openInfoWindow(infoWindow, point); //开启信息窗口
		/*marker.addEventListener("click", function(){
		});*/
	} );

	var key="f30da8ee-61da-4c1a-bd73-54fee1d19d69";
	function initChePai(){
		$.ajax({
	// get请求地址
			url: "http://58.222.201.158:6809/deviceData/vehicleBaseInfo.do?key="+key,
			dataType: "json",
			success: function (data) {

				for (var i = 0; i < data.obj.length; i++) {
					$('.selectpicker').append("<option value=" + data.obj[i].id + ">" + data.obj[i].plate + "</option>");
				}

				$('#suggestId').selectpicker({
					'selectedText': 'cat',
					'noneSelectedText': '请选择',
					'deselectAllText': '全不选',
					'selectAllText': '全选'
				});
				// 缺一不可
				$('#suggestId').selectpicker('refresh');
				$('#suggestId').selectpicker('render');

			}
		});
	}

	function search(){
		var chepaipID=$('#suggestId').val().toString();
		let starthaomiao = getHaomiao($("#starTime").val());
		let endTimehaomiao = getHaomiao($("#endTime").val());
		if(chepaipID!=""&&chepaipID!=undefined&&chepaipID!=null&&$("#starTime").val()!=null&&$("#starTime").val()!=""&&$("#starTime").val()!=undefined
				&&$("#endTime").val()!=null&&$("#endTime").val()!=""&&$("#endTime").val()!=undefined){
			getlichengguiji(chepaipID,starthaomiao,endTimehaomiao)
		}else{
			toastr.error("请选择车牌和时间")
			alert("请选择车牌和时间")
		}
	}

	function getlichengguiji(chepaipID,starthaomiao,endTimehaomiao){
		$.ajax({
			// get请求地址
			url: "http://58.222.201.158:6809/track/queryTrackData.do?key="+key+"&startTime="+starthaomiao+"&endTime="+endTimehaomiao+"&id="+chepaipID,
			dataType: "json",
			success: function (data) {
				if(data.flag==1){
					setDiTu(data.obj);
					$('#mainContent').dataTable().fnClearTable();
					$('#mainContent').DataTable().rows.add(data.obj).draw(false);
				}else{
					toastr.error(data.msg)
				}
			}
		});
	}

	function setDiTu(data){
		map.enableScrollWheelZoom();//启用缩放
		//起点-途经点-终点 有bug,3.0z这个方法只有百度2.0支持，3.0报错画出的路线不准,单2.0途径点数量有限制，爷青结
		/*if(data!=null&&data.length!=0){
			var pois = [];
			var start;
			var end;
			var flag=true;
			for(var i=0;i<data.length;i++){
				if(flag){
					start = new BMap.Point(data[0].lon,data[0].lat);
					end = new BMap.Point(data[(data.length-1)].lon,data[(data.length-1)].lat);
				}
				pois.push(new BMap.Point(data[i].lon,data[i].lat))


			}
			var driving = new BMap.DrivingRoute(map, {renderOptions:{map: map, autoViewport: true}
			});
			//driving.search(start, end);
			driving.search(start, end,{waypoints:pois});//waypoints表示途经点

		}*/
		//轨迹
		var sy = new BMap.Symbol(BMap_Symbol_SHAPE_BACKWARD_OPEN_ARROW, {
			scale: 0.6,//图标缩放大小
			strokeColor:'#fff',//设置矢量图标的线填充颜色
			strokeWeight: '2',//设置线宽
		});
		var icons = new BMap.IconSequence(sy, '10', '0');
		// 创建polyline对象
		var pois = [];

		if(data!=null&&data.length!=0){
			for(var i=0;i<data.length;i++){
				pois.push(new BMap.Point(data[i].lon,data[i].lat))
			}
		}
		var polyline =new BMap.Polyline(pois, {
			enableEditing: false,//是否启用线编辑，默认为false
			enableClicking: true,//是否响应点击事件，默认为true
			icons:[icons],
			strokeWeight:'8',//折线的宽度，以像素为单位
			strokeOpacity: 0.8,//折线的透明度，取值范围0 - 1
			strokeColor:"#18a45b" //折线颜色
		});
		clearAll()
		map.addOverlay(polyline);          //增加折线
		map.setViewport(pois);
	}



	let map = new BMap.Map("container"); // 创建Map实例,GL版命名空间为BMapGL(鼠标右键控制倾斜角度)
	map.centerAndZoom(new BMap.Point(116.404, 39.915), 11);      // 初始化地图,设置中心点坐标和地图级别
	map.enableScrollWheelZoom(true);


	// 百度地图API功能
	function G(id) {
		return document.getElementById(id);
	}



	// 定义一个控件类,即function
	function ZoomControl() {
		this.defaultAnchor = BMAP_ANCHOR_TOP_LEFT;
		this.defaultOffset = new BMap.Size(10, 10);
	}

	// 通过JavaScript的prototype属性继承于BMap.Control
	ZoomControl.prototype = new BMap.Control();

	// 自定义控件必须实现自己的initialize方法,并且将控件的DOM元素返回
	// 在本方法中创建个p元素作为控件的容器,并将其添加到地图容器中
	ZoomControl.prototype.initialize = function(map){
		// 创建一个DOM元素
		var p = document.createElement("p");
		p.innerHTML = '<div class="ceng" style="width: 250px;background-color: white;box-shadow:grey 0px 0px 5px">' +
				'<p id="r-result" style="padding:10px;">车辆筛选:<!--<input type="text" id="suggestId" size="20" value="百度" placeholder="支持搜索" style="width:150px;" />-->' +
				'<select class="form-control selectpicker" multiple data-max-options="1" data-actions-box="false"' +
				'data-live-search="true"  id="suggestId"   style="width:80%;"></select></p>' +
				'<div class="ivu-col ivu-col-span-8" style="padding:5px;">选择时间：</div>' +
				' <div class="ivu-col ivu-col-span-16"><!--<button onclick="getDay(0)"  class="layui-btn layui-btn-normal">今天</button>--> <button onclick="getDay(-1)" class="layui-btn layui-btn-normal" style="margin-left:15px">昨天</button> <button onclick="getDay(-3)"  class="layui-btn layui-btn-normal">近三天</button> <button onclick="getDay(-7)"  class="layui-btn layui-btn-normal">近七天</button></div>'+
				'<div class="ivu-col ivu-col-span-7"style="padding:5px;">开始时间：</div>' +
				' <div class="ivu-col ivu-col-span-17">' +
				'<input type="text" autocomplete="off" id="starTime" placeholder="选择日期时间" style="height:30px;margin-left:10px;" ></div>' +
				'<div class="ivu-col ivu-col-span-7"style="padding:5px;">结束时间：</div>' +
				' <div class="ivu-col ivu-col-span-17">' +
				'<input type="text" autocomplete="off" id="endTime" placeholder="选择日期时间"  style="height:30px;margin-left:10px;"></div>' +
				'<button type="button" onclick="search()" class="search-btn-track ivu-btn ivu-btn-primary ivu-btn-small layui-btn layui-btn-normal" style="margin:10px;"> <span>查找</span></button></div>';

		p.onclick = function(e){
			map.disableScrollWheelZoom();//禁止缩放
		}

		initChePai()
		// 添加DOM元素到地图中
		map.getContainer().appendChild(p);
		// 将DOM元素返回
		return p;


	}

	// 创建控件
	var myZoomCtrl = new ZoomControl();
	// 添加到地图当中
	map.addControl(myZoomCtrl);


	function clearAll(){
		map.clearOverlays();    //清除地图上所有覆盖物
	}


</script>
