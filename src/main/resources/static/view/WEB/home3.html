<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8" />
		<title>首页</title>
		<link rel="stylesheet" type="text/css" href="../css/bootstrap.css" />
		<link rel="stylesheet" type="text/css" href="../css/bootstrap.min.css" />
		<!-- <link rel="stylesheet" type="text/css" href="../css/bootstrap-theme.css" /> -->
		<link rel="stylesheet" type="text/css" href="../css/layui.css" />
		<!--<link rel="stylesheet" type="text/css" href="../css/index.css" />-->
		<style>
			.main-table tr td {
				padding: 3px;
			}
			
			.main-table .red {
				color: red;
			}
			
			.layui-tab-title .layui-this {
				background-color: #2D70BE;
			}
			
			.layui-this {
				border: 0px solid #dedede !important;
				
			}
			
			.layui-tab-title li {
				border: 1px solid #3574C1;
				border-radius: 50%;
				height: 15px;
				width: 15px;
				min-width: 5px;
				padding: 0px;
				margin-right: 100px;
				background-color: white;
			}
			
			.layui-tab-title {
				border: 0px solid #dedede !important;
			}
			
			.layui-tab-item {
				margin-left: -30px !important;
			}
			.layui-tab-title li{
			   color:#397EEB;
			    padding-top:5px;
			    padding-left:-30px;
			}
			.layui-this{
			   color:#397EEB !important;
			   font-weight:bolder;
			    padding-top:5px;
			    padding-left:-30px;
			}
			.righttop {
					margin-top: -20% !important;
				}
				.rightbottom {
					top: 200px !important;
				}
				.rightbottom span {
					margin-top: 1% !important;
				}
			.main{
			    margin-left:0.5%  !important;
			}
			.title{
			    margin-left:2% !important;
			}
			@media screen and (max-width: 1366px) {
				#main{
				   width:500px !important;
				   height:400px !important;
				 /*   margin:-85% 15px 0px -40% !important; */
				}
				.rightfirst{
				   width:400px !important;
				   height:250px !important;
				}
				.rightsec{
				   width:400px !important;
				   margin-top:24%  !important;
				   height:250px !important;
				}
				.main{
				   top:9% !important;
				}
				#chart1{
				   height:230px !important;
				   width:380px !important;
				}
				#chart2{
				   height:230px !important;
				   margin-top:-40px;
				   width:380px !important;
				   margin-left:20px;
				   
				}
				#chart3{
				   height:220px !important;
				    width:480px !important;
				   /*  margin-top:-40px; */
				}
				.table{
				   height:500px !important;
				}
			}
			@media screen and (max-width: 1600px) {
			     .rightfirst{
				   width:450px;
				   height:250px !important;
				   right:30px;
				}
				.rightsec{
				   width:450px ;
				   margin-top:21%  !important;
				   height:300px !important;
				   right:0px;
				}
				#chart2{
				   height:290px !important;
				   width:400px !important;
				}
				.table{
				   height:600px ;
				}
			}
		</style>
	</head>

	<body class="jd" style="background-color: #F5F5F5;">
	<div class="head" style="height: 100%;width: 100%;"></div>
			<div class="left" style="width:1000px;" id="hsMap">
		    <div class="main"style="width: 58%;height: 90%;overflow: hidden;margin:0;position: absolute;top:7%;left:2%;border:2px solid #1F99ee;"
		         id="dituContent"></div>
		    <div class="center_text">
		    </div>
		</div>
		
		<div class="y-span10 y-last">
			<div class="B" style="float: right;">
				<div class="rightfirst col-xs-4" style="float: right;background-color: white;margin-right: 0px;height: 380px;width: 580px;">
					<div class="title2" style="margin-left: 1%;padding-top: 2%;">
						<img src="../images/dec.png" />
						<p style="display: inline-block;color: #1897e8;font-size: 15px;font-weight: bold;margin-left: 1%;">供需统计</p>
					</div>
					<!--标题结束-->
					<div id="chart1" style="width:550px; height: 360px;"></div>
				</div>
				<div class="rightsec col-xs-4" style="float: right;background-color: white;margin-right: 2%;height: 430px;width: 580px;position: absolute;margin-top: 24%;">
					<div class="title3" style="margin-left: 1%;padding-top: 2%;">
						<img src="../images/dec.png" />
						<p style="display: inline-block;color: #1897e8;font-size: 15px;font-weight: bold;margin-left: 1%;">日生产量统计</p>
					</div>
					<!--标题结束-->
					<div id="chart2" style="width:550px; height:400px;"></div>
				</div>
				<!-- <div id="cbjdtj" class="rightsec col-xs-4" style="float: right;background-color: white;margin-right: 2%;height: 260px;width: 580px;position: absolute;margin-top: 36%;">
					<div class="title3" style="margin-left: 1%;padding-top: 2%;">
						<img src="../images/dec.png" />
						<p style="display: inline-block;color: #1897e8;font-size: 15px;font-weight: bold;margin-left: 1%;">成本及进度管理统计</p>
						<input type="date" name="" id="" value="" / style="float: right;height: 25px;">
					</div>
					标题结束
					<div id="chart3" style="width:550px; height: 250px;"></div>

				</div> -->
			</div>
			<div class="table" style="background-color: #FFF;width: 60%;height: 820px;margin-left: 1%;margin-top: 1%;">

				<div class="bj_nav y-clearfix">
					<div class="title" style="margin-left: 1%;padding-top: 1%;position:absolute;float:left;width:100%;">
						<img src="../images/dec.png" />
						<p style="display: inline-block;color: #1897e8;font-size: 15px;font-weight: bold;margin-left: 1%;">施工地点</p>
					</div>
					
				</div>
				<!-- <div class="jt" style="margin-top: 845px;">
					<a href="" style="display: inline-block;position: absolute;left: 100px;"><img src="../images/icon_left2.png" /></a>
					<a href="" style="display: inline-block;position: absolute;left: 100px;margin-left: 800px;"><img src="../images/icon_right1.png" /></a>
				</div> -->

			</div>

		</div>
	</div>
	<!-- 左边结束 -->
	</body>
	<script src="../js/jquery.min.js" type="text/javascript" charset="utf-8"></script>
	<script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js?_v_=1595477515301" type="text/javascript"
			charset="utf-8"></script>
	<!-- <script src="../js/layui.js" type="text/javascript" charset="utf-8"></script>
	<script src="../js/element.js" type="text/javascript" charset="utf-8"></script> -->
	<script src="../js/myEcharts.js" type="text/javascript" charset="utf-8"></script>
	<script src="../js/myUtil.js" type="text/javascript" charset="utf-8"></script>
	<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
	<script src="https://cdn.staticfile.org/vue-resource/1.5.1/vue-resource.min.js"></script>
	<script src="../js/build/dist/echarts.js" type="text/javascript" charset="utf-8"></script>
	<script src="../js/homeEchars.js" type="text/javascript" charset="utf-8"></script>
	<script src="../easyUI/jquery.easyui.min.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript" src="https://api.map.baidu.com/api?v=3.0&ak=BmTwezCvWyGaH3KNYkc5P6uq&s=1"></script>
	<script type="text/javascript">
		$(document).ready(function () {

		});

		let points = [{
			id: 1,
			lng: 118.096525,
			lat: 24.462602,
			title: "工地名称：厦门中山公园",
			content: ["经度：118.096525;纬度：24.462602", "桩号：010 ; 车道：010"]
		}];
		let page_map;
		page_map = new BMap.Map("dituContent");

		// 百度地图API功能
		//GPS坐标
		let x = 119.605720;
		let y = 32.989924;
		let ggPoint = new BMap.Point(x,y);
		// 创建点坐标
		page_map.centerAndZoom(ggPoint, 8);
		page_map.enableScrollWheelZoom();   //启用滚轮放大缩小，默认禁用
		page_map.addControl(new BMap.ScaleControl());
		page_map.addControl(new BMap.NavigationControl());

		/*    let zoomCtrl = new BMap.ZoomControl({anchor: BMAP_ANCHOR_BOTTOM_RIGHT, offset: new BMap.Size(20, 20)});
            page_map.addControl(zoomCtrl);*/




		let luduanVm = new Vue({
			el: '#luduan',
			//表单数据
			data: {
				roadId:"",
				roadNo:"",
				roadName:"",
				startLng:"",
				startLat:"",
				endLng:"",
				endLat:"",
				remarks:"",
				expresswayName:"",
				allXuQiu:'',
				allGongYing:'',
				roadList:'',
			},
			methods: {
				roadPost:function(){
					//发送 post 请求  then中第一个function或者箭头函数为success回调函数, 第二个function为失败fail回调函数
					this.$http.post('/SysRoadMgnController/getAllSysRoadMgnVoHomePage',{},{emulateJSON:true}).then((res)=>{
						this.roadList=res.body;
						this.initMap();
					},(res)=>{
						console.log(res.status);
					});
				},
				initMap:function(){
					let rdList = this.roadList;
					for(let i in rdList){
						let p1 = new BMap.Point(rdList[i].startLng,rdList[i].startLat);
						let p2 = new BMap.Point(rdList[i].endLng,rdList[i].endLat);
						let driving = new BMap.DrivingRoute(page_map, {renderOptions:{map: page_map, autoViewport: false}});
						pageDom.arr[i] = driving;
						driving.search(p1, p2);
					}
					//page_map.centerAndZoom("江苏", 7);
					/* page_map.panTo(new BMap.Point(120.5195950,31.9281190));*/

				},
				dwMap:function(e,index){
					clearResult(pageDom.arr);
					let p1 = new BMap.Point(e.startLng,e.startLat);
					let p2 = new BMap.Point(e.endLng,e.endLat);
					let driving1 = new BMap.DrivingRoute(page_map, {renderOptions:{map: page_map, autoViewport: false}});
					pageDom.arr.push(driving1);
					driving1.search(p1, p2);
				},
			}
		})
		//luduanVm.roadPost();
		let pageDom = {};
		pageDom.arr = [];

		function clearResult(arr){
			for(let i in arr){
				let driveIndex = arr[i];
				driveIndex.clearResults();
			}
		}


		let getRandomColor = function(){
			return '#'+Math.floor(Math.random()*16777215).toString(16);
		}


		$(document).ready(function () {
			initTableQuanxian()
			getEcahrsData()
			getEcahrsData2()
			getEcahrsData3()
			initPoint()
		});

		let geoCoordMap = [];

		let page_point;
		let page_pointArray;

		function initPoint() {
			$.ajax({
				type: 'POST',
				url: '/TanPuDiDianGuanLi/getAllTanPuDiDianVoByState',
				dataType: 'json',
				data: {
					state: 1
				},
				async: false,
				error: function (msg) {
					errMessage("请求UserController失败");
				},
				success: function (json) {

					let siteList = json.siteList;
					let nowShengChanJiHua = json.nowShengChanJiHua;
					/*let pointArray = [];
					let array = {};
					for (let i in json) {
						let lngLat = [];
						lngLat[0] = json[i].lng;
						lngLat[1] = json[i].lat;
						array[json[i].stakemark] = lngLat;
						// let point = new BMap.Point(json[i].lng, json[i].lat);
						// addMarker(point, json[i].stakemark, json[i].lane, json[i]);
						let point = {};
						point.name = json[i].stakemark;
						//point.value = "";
						point.value = lngLat;
						pointArray.push(point);
					}
					page_pointArray = pointArray
					page_point = array;*/
					for (let i in siteList) {
						json = siteList
						let point = new BMap.Point(json[i].lng, json[i].lat);
						if (null != json[i].finishTime) {
							let finishtime = json[i].finishTime;
							const time = new Date();
							time.setTime(time.getTime());
							let now = time.Format("yyyy-MM-dd HH:mm:ss");
							let now0 = time.Format("yyyy-MM-dd") + " 00:00:00";
							let nowPlanId = time.Format("yyyy-MM-dd") + " 00:00:00";
							let siteId = json[i].id;
							let nowSiteId='';
							if (nowShengChanJiHua != null) {
								now = nowShengChanJiHua.finishTime;
								nowSiteId=nowShengChanJiHua.siteId;
							}

							if(siteId==nowSiteId){
								//正在进行
								addMarker(point, json[i].stakemark, json[i].lane, json[i], 1);
							}else {
								if (finishtime < now && finishtime > now0) {
									//已完成
									addMarker(point, json[i].stakemark, json[i].lane, json[i], 3);
								} else if (finishtime >= now) {
									//未完成
									addMarker(point, json[i].stakemark, json[i].lane, json[i], 4);
								}
							}
						}
					}
				}
			});
		}

		function dianImg(e) {
			let imgArr = ['../images/wz1.png', '../images/wz2.png', '../images/wz3.png', '../images/wz4.png', '../images/wz5.png', '../images/wz6.png', '../images/wz7.png', '../images/wz8.png', '../images/wz9.png', '../images/wz10.png', '../images/wz11.png', '../images/wz12.png', '../images/wz13.png', '../images/wz14.png', '../images/wz15.png', '../images/wz16.png', '../images/wz17.png', '../images/wz18.png', '../images/wz19.png', '../images/wz20.png', '../images/wz21.png', '../images/wz22.png', '../images/wz23.png', '../images/wz24.png'];
			let imgSrc = imgArr[e];
			return imgSrc;
		};

		function addMarker(point, stakemark, lane, obj, i) {
			let stateText;
			switch (i) {
				case 1:
					stateText='正在进行';
					break;
				case 3:
					stateText='已完成';
					break;
				case 4:
					stateText='未完成';
					break;
			}

			let marker = new BMap.Marker(point, {
				icon: new BMap.Icon(dianImg(i), new BMap.Size(30, 30), {
					anchor: new BMap.Size(52, 26),
					imageSize: new BMap.Size(30, 30)
				})
			});
			let sContent =
					"<h4 style='margin:0 0 5px 0;padding:0.2em 0'>桩号: " + obj.stakemark + "</h4>" + "<br/>"+
					"<h4 style='margin:0 0 5px 0;padding:0.2em 0'>路段名称: " + obj.roadname + "</h4>" + "<br/>"+
					"<h4 style='margin:0 0 5px 0;padding:0.2em 0'>施工队: " + obj.team + "</h4>" + "<br/>"+
					"<h4 style='margin:0 0 5px 0;padding:0.2em 0'>生产状态: " + stateText + "</h4>" + "<br/>";
			let infoWindow = new BMap.InfoWindow(sContent);
			page_map.addOverlay(marker);
			marker.addEventListener("click", function () {
				this.openInfoWindow(infoWindow);
			});
		}



		function initTableQuanxian(){
			$.ajax({
				type:"post",
				url:"/login/getUser",
				async:false,
				data:{
				},
				success:function(json){
					let name=json.department;
					if(name=="拌合站"){
						$("#cbjdtj").show();
					}else{
						$("#cbjdtj").hide();
					}


				}
			});
		}
		//require.config({
		//	paths: {
		//		echarts: '../js/build/dist'
		//	}
		//});

		// 使用
		//require(
		//		[
		//		'echarts',
		//		'echarts/chart/map',
		//		'echarts/chart/lines',
		//		'echarts/chart/effectScatter',
		//	],
		//	function(ec) {
		//
		//	}
		//);
		//require('echarts/util/mapData/params').params.jiangsu = {
		//
		//				getGeoJson: function(callback) {
		//			$.getJSON('../geoJson/jiangsu.json', function(data) {
		//				// 压缩后的地图数据必须使用 decode 函数转换
		//			callback(require('echarts/util/mapData/params').decode(data));
		//		});
		//	}
		//}


		$.getJSON('../geoJson/jiangsu.json', function(data) {
			// 压缩后的地图数据必须使用 decode 函数转换
			echarts.registerMap('jiangsu', data);
			let myChart = echarts.init(document.getElementById('main'));
			//let ecConfig = require('echarts/config');
			//let zrEvent = require('zrender/tool/event');
			let curIndx = 0;
			let mapType = ["江苏"];
			//myChart.on(ecConfig.EVENT.MAP_SELECTED, function(param) {});
			option = {
				tooltip: {
					trigger: 'item',
					formatter: function (params) {
						if(typeof(params.value)[2] == "undefined"){
							return params.name + ' : ' + params.name;
						}else{
							return params.name + ' : ' + params.name;
						}
					}
				},
				legend: {
					orient: 'vertical',
					x: '',
					data: [' ']
				},
				geo:{
					map: 'jiangsu',
					itemStyle: {
						normal: {
							color: '#2e70bc', //地图背景色
							label: {
								show: true
							},
							borderColor: '#82E1FF',
							borderWidth: 1
						},

						emphasis: {
							label: {
								show: true,
								normal: {}
							}
						}
					},
				},
				series: [
					{
						type: 'effectScatter',
						coordinateSystem: 'geo',
						symbol: 'pin',
						symbolSize: 15,
						itemStyle: {
							normal: {
								show:true,
								textStyle: {
									color: 'red'
								},
								color: '#7FE0FF'
							}
						},
						data: page_pointArray
					},{
						type: 'lines',

						//coordinateSystem: 'bmap',
						data: [
							{
								coords:[
									[119.001041,33.510774],
									[119.925266,33.348602],
									[118.918166,31.931157],
									[118.926861,31.923372],
									[118.926861,31.923372],
								]
							}],
						polyline: true,
						lineStyle: {
							color: 'white',
							opacity: 1,
							width: 2
						}
					}]
			}
			myChart.setOption(option,true);
			myChart.on('click', function(params) {
			});
		});



		function getEcahrsData(){
			$.ajax({
				type: 'POST',
				url: '/SysRoadMgnController/getAllSysRoadMgnVoHomePage',
				dataType: 'json',
				data: {
					state: 1
				},
				error: function (msg) {
					errMessage("请求UserController失败");
				},
				success: function (json) {
					let xuqiu=[]
					let gongying=[]
					let roadname=[]
					if(json!=null&&json.length!=0){
						for(let i=0;i<json.length;i++) {
							xuqiu.push(json[i].allXuQiu)
							gongying.push(json[i].allGongYing)
							roadname.push(json[i].stakemark)
						}
					}else {
						xuqiu.push(0)
						gongying.push(0)
						roadname.push("")
					}
					initMychart1(xuqiu,gongying,roadname);
				}
			});
		}
		function initMychart1(xuqiu,gongying,roadname) {
			let chart = echarts.init(document.getElementById('chart1'));
			// 使用刚指定的配置项和数据显示图表。
			let option = setHomeLDGXTJ(xuqiu,gongying,roadname);
			chart.setOption(option);
		}

		function getEcahrsData2(){
			$.ajax({
				type: 'POST',
				url: '/SysRoadMgnController/getDayWeightCount',
				dataType: 'json',
				data: {

				},
				error: function (msg) {
					errMessage("请求UserController失败");
				},
				success: function (json) {
					let dayTime=[]
					let totalWeight=[]
					if(json!=null&&json.length!=0){
						for(let i=0;i<json.length;i++){
							dayTime.push(json[i].dayTime)
							totalWeight.push(json[i].totalWeight)
						}
					}
					initMychart2(dayTime,totalWeight);
				}
			});
		}

		function initMychart2(dayTime,totalWeight) {
			let chart = echarts.init(document.getElementById('chart2'));
			// 使用刚指定的配置项和数据显示图表。
			let option = setHomeZPZHTJ(dayTime,totalWeight);
			chart.setOption(option);
		}

		function getEcahrsData3(){
			$.ajax({
				type: 'POST',
				url: '/ChenBenJinDu/getAllChenBenJinDu',
				dataType: 'json',
				data: {

				},
				error: function (msg) {
					errMessage("请求UserController失败");
				},
				success: function (json) {

					let datetime=[]
					let chenneng=[]
					let feiliao=[]
					if(json!=null&&json.length!=0){
						for(let i=0;i<json.length;i++){
							datetime.push(json[i].datetime)
							chenneng.push(json[i].chenneng)
							feiliao.push(json[i].feiliao)
						}
					}
					initMychart3(datetime,chenneng,feiliao);
				}
			});
		}

		function initMychart3(datetime,chenneng,feiliao) {
			let chart = echarts.init(document.getElementById('chart3'));
			// 使用刚指定的配置项和数据显示图表。
			let option = setHomeCBJDTJ(datetime,chenneng,feiliao);
			chart.setOption(option);
		}

	</script>

</html>