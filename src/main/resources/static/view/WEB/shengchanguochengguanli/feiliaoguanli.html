<!DOCTYPE html>
<html lang="en">
<head>
	 <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
   <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="../../font2/iconfont.css">
	<link href="../../style/bootstrap.min.css" rel="stylesheet">
    <link href="../../style/style.css" rel="stylesheet">
    <link rel="stylesheet" href="../../style/jquery.dataTables.min.css">
    <link rel="stylesheet" href="../../style/jquery-editable-select.css">
	<link rel="stylesheet" type="text/css" href="../../easyUI/themes/default/easyui.css" />
	<link rel="stylesheet" type="text/css" href="../../easyUI/themes/icon.css" />
	<link rel="stylesheet" type="text/css" href="../../easyUI/demo/demo.css" />
	<link rel="stylesheet" type="text/css" href="../../css/layui.css" />
	<link rel="stylesheet" type="text/css" href="../../css/layui.mobile.css" />
	<link rel="stylesheet" type="text/css" href="../../css/laydate.css" />
	<link rel="stylesheet" type="text/css" href="../../css/code.css" />
	<link rel="stylesheet" type="text/css" href="../../../js/skin/default/layer.css" />
    <link rel="stylesheet" type="text/css" href="../../css/laydate.css" />
    <link href="../../toastr/toastr.css" rel="stylesheet">
	    <!-- SmartAdmin Styles : Caution! DO NOT change the order -->
   <link rel="stylesheet" type="text/css" media="screen" href="../../css/smartadmin-production-plugins.min.css">
    <link rel="stylesheet" type="text/css" media="screen" href="../../css/smartadmin-production.min.css">
    <link rel="stylesheet" type="text/css" media="screen" href="../../css/smartadmin-skins.min.css">
    <link rel="stylesheet" type="text/css" media="screen" href="../../css/font.css">
     <!-- SmartAdmin RTL Support  -->
    <link rel="stylesheet" type="text/css" media="screen" href="../../css/smartadmin-rtl.min.css">
    <link rel="stylesheet" type="text/css" media="screen" href="../../css/all.css">
	<style lang="">
		 .UpperPart{
            display: flex;
            justify-content:space-between;
            /* border-bottom: 1px solid #ccc; */
            height:0px;
            padding-bottom: 12px;
        }
		.selected{
			background: rgba(247, 161, 3,0.2);
		}
		#mainContent th{
			cursor: pointer;
		}
	</style>
</head>
<body>

<!-- 面包屑 -->
<div class="mianbao">
	<ul class="breadcrumb">
		<li><i class="iconfont icon-knowledgebase"></i></li>
		<li>沥青砼生产过程管理</li>
		<li class="active">废料管理</li>
	</ul>
</div>

<div class="zhuti-content">
	<div class="UpperPart">
		<div class="UpperPartL">
			<!-- <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#myModal" style="margin: 5PX;">录入</button> -->
		</div>
		<div class="UpperPartR">
			<!--<button type="button" class="btn btn-primary" style="margin: 5PX;">导出Excel文件</button>-->
		</div>

	</div>
	<div class="LowerPart" style="margin-top:3px;">
		<table class="layui-table" lay-skin="line"  id="mainContent" style="white-space: nowrap;">
			<thead>
			 <tr style="background-color:#EBF4FF;border-bottom:none;background-image:none;">
				<th>编号</th>
				<th>路段名称</th>
				<th>批次</th>
				<th>报废重量</th>
				<th>报废类型</th>
				<th>报废单价</th>
				<th>报废原因</th>
				<th>预警状态</th>
				<th>报废时间</th>
				<th>操作人</th>
				<th>操作</th>
			</tr>
			</thead>
			<tbody>

			</tbody>
		</table>
	</div>
</div>
<!-- allMsg -->
<div class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" id="allMsg1">
	<div class="modal-dialog modal-lg" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title" ><b>所有信息</b></h4>
			</div>
			<div class="modal-body">
				<div>
					<form class="form-inline">
						<table class="table table-bordered">
							<tr>
								<td style="width: 20%;">序号</td>
								<td style="width: 30%;">1</td>
								<td style="width: 20%;">时间</td>
								<td style="width: 30%;">2019-10-23 11:23:22</td>

							</tr>
							<tr>
								<td>路段编号</td>
								<td>1</td>
								<td>沥青砼批次</td>
								<td>1</td>
							</tr>
							<tr>
								<td>沥青砼类型</td>
								<td>1</td>
								<td>预警内容</td>
								<td>1</td>
							</tr>
						</table>
					</form>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
			</div>
		</div>
	</div>
</div>
<!-- allMsg结束 -->
<div class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" id="diaodu">
	<div class="modal-dialog modal-lg" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title" ><b>调度</b></h4>
			</div>
			<div class="modal-body">
				<div>
					<form class="form-inline">
						<table class="layui-table "lay-skin="line" style="height:auto;" >
							<tr>
								<td>生产计划编号</td>
								<td>
									<select  class="form-control"  v-model="planId" style="width: 100%;">
										<option :value="item.planid" v-for="item in planList">{{item.planno}}</option>
									</select>
								</td>
							</tr>

						</table>
					</form>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-success" data-dismiss="modal" @click="save">保存</button>
				<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
			</div>
		</div>
	</div>
</div>
</body>
<script src="../../js/jquery.js"></script>
<script src="../../js/common-scripts.js"></script>
<script src="../../js/bootstrap.min.js"></script>
<script src="../../js/jquery.dataTables.min.js"></script>
<script src="../../toastr/toastr.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://cdn.staticfile.org/vue-resource/1.5.1/vue-resource.min.js"></script>
<script src="../../js/SmartNotification.min.js"></script>
<script src="../../js/myTool.js"></script>
<script src="../../js/quanxian.js"></script>
<script>
	$(document).ready( function () {
		initTable();
	});
	var table=$('#mainContent').dataTable({
		"deferRender": true,
		"processing": true,
		"bDestroy": true,
		"iDisplayLength": 10,
		"searching": true,
		"lengthChange": false,
		"oLanguage": {
			"sSearch": '<span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span>'
		},
		"order": [[1, 'asc']],
		"columns" : [ {
			"data" : "wasteNo"
		}, {
			"data" : "roadName"
		}, {
			"data" : "batch"
		}, {
			"data" : "pitchWeight"
		}, {
			"data" : "flName"
		}, {
			"data" : "unitPrice"
		}, {
			"data" : "reason"
		}, {
			"data" : "warningState"
		}, {
			"data" : "dealTime"
		}, {
			"data" : "uname"
		}, {
			"data" : "id"
		}],
		"columnDefs" : [ {
			"class": "tcenter",
			"targets": 10,
			"searchable": true,
			"render": function (data, type, full) {
				//var xiugai = '<i class="iconfont icon-xiugai" style="font-size:18px;cursor:pointer;" data-f="'+ full+ '"   onclick="udMsg(this)" title="修改" data-toggle="modal" data-target="#change"></i>';
				//var qiyong = '<i class="iconfont icon-shanchu" style="font-size:18px;cursor:pointer;" data-id="'+ data+ '" onclick="delMsg(this)" title="删除"></i>';
				var quxiao = '<i class="glyphicon glyphicon-share-alt Pbga" style="font-size:18px;cursor:pointer;display:none;" data-id="' + data + '" onclick="quxaio(this)" title="取消"></i> &nbsp';
				var feiqi = '<i class="glyphicon glyphicon-floppy-remove Pbgb" style="font-size:18px;cursor:pointer;display:none;" data-id="' + data + '" onclick="feiqi(this)" title="废弃"></i> &nbsp'
				var diaodu = '<i class="glyphicon glyphicon-log-out Pbgc" style="font-size:18px;cursor:pointer;display:none;" data-id="' + data + '" onclick="diaodu(this)" title="调度"></i>'
				if (full.warningState == "0") {
					return quxiao + feiqi + diaodu;
				} else if (full.warningState == "1") {
					return '';
				}else{
					return '';
				}
			}
		}, {
			"class": "tcenter",
			"targets": 7,
			"searchable": true,
			"render": function (data, type, full) {
				if (data == '0') {
					return '<span class="label label-success state">未操作</span>';
				} else if (data == '1') {
					return '<span class="label label-info state">完全废弃</span>';
				} else if (data == '2') {
					return '<span class="label label-danger state">已调度</span>';
				} else if (data == '3') {
					return '<span class="label label-default state">已取消</span>';
				}
			}
		}
		], "fnDrawCallback": function () {
			initTableQuanxian()
		},
		//让表格出横向滚动条 ，此时 表头和 表中数据将分为两个部分
		"sScrollX": true,
		// 让表格的宽度不自适应 ，固定宽度。 如果不设置 表头和表中数据会分离
		//表中的数据自适应 ，表头的宽度固定
		"bAutoWidth": false,
		"order": [[8, 'desc']],
		"oLanguage": { //国际化配置
			"sProcessing": "正在获取数据，请稍后...",
			"sLengthMenu": "显示 _MENU_ 条",
			"sZeroRecords": "查询不到相关数据",
			"sInfo": "从 _START_ 到  _END_ 条记录 总记录数为 _TOTAL_ 条",
			"sInfoEmpty": "记录数为0",
			"sInfoFiltered": "(全部记录数 _MAX_ 条)",
			"sInfoPostFix": "",
			"sSearch": "搜索",
			"sUrl": "",
			"oPaginate": {
				"sFirst": "第一页",
				"sPrevious": "上一页",
				"sNext": "下一页",
				"sLast": "最后一页"
			}},

	});

	function initTableQuanxian(){
		$.ajax({
			type:"post",
			url:"/login/getUser",
			async:false,
			data:{
			},
			success:function(json){
				if(json!=null &&json!=""){
					var arr = json.uPermissions.split(',');
					for(var i=0;i<arr.length;i++){
						var arr2 = arr[i].replace("+","");
						if(arr[i].indexOf("Pbga") >= 0 ){
							$(".Pbga").show();
						}
						if(arr[i].indexOf("Pbgb") >= 0 ){
							$(".Pbgb").show();
						}
						if(arr[i].indexOf("Pbgc") >= 0 ){
							$(".Pbgc").show();
						}
					}

				}

			}
		});
	}

	function initTable(){
		$.ajax({
			type: 'POST',
			url: '/WhWasteMgn/getAllWhWasteMgn',
			dataType: 'json',
			data: {
			},
			error: function (msg) {
				errMessage("请求UserController失败");
			},
			success: function (json) {
				$('#mainContent').dataTable().fnClearTable();
				$('#mainContent').DataTable().rows.add(json).draw(false);
			}
		});
	}

	//箭头函数，内部this永远指向父级
	var delMsg = (e)=>{
		var tr = $(e).parents("tr");
		var data=$("#mainContent").DataTable().row(tr).data();
		var msg = "确定要删除吗？\n\n请确认！";
		if (confirm(msg) == true) {
			$.ajax({
				type: 'POST',
				url: '/LaiLiaoWenDuYuJing/delLaiLiaoWenDu',
				dataType: 'json',
				data: {
					id:data.id
				},
				error: function (msg) {
					errMessage("请求UserController失败");
				},
				success: function (json) {
					if(json>0){
						toastr.success("删除成功");
						$('#mainContent').DataTable().row(tr).remove().draw(false); //删除行立即显示
					}else{
						toastr.error("删除失败");
					}
				}
			});
		}else{
			return false;
		}
		console.log(msg);
	}

	function diaodu(obj){
		var tr=$(obj).parents("tr");
		var data=$("#mainContent").DataTable().row(tr).data();
		Newdiaodu.planSelect(data.planId);
		Newdiaodu.batchId=data.batchId;
		Newdiaodu.feiliaoId=data.id;
		$("#diaodu").modal('show')
	}

	var Newdiaodu = new Vue({
		el: '#diaodu',
		//表单数据
		data: {
			id:"",
			batchId:"",
			planList:"",
			planId:"",
			feiliaoId:"",
		},
		methods: {
			//新建生产计划保存按钮事件
			save: function () {
				//发送 post 请求  then中第一个function或者箭头函数为success回调函数, 第二个function为失败fail回调函数
				this.$http.post('/ProductDispatch/insertProductDispatch',JSON.stringify(this._data),{}).then((res)=>{
					var resMsg = res.body;
					if(resMsg.result>0){
						initTable();
						$("#diaodu").modal("hide");
						toastr.success(resMsg.msg);
					}else{
						toastr.error(resMsg.msg);
					}
				},(res)=>{

				});
			},
			planSelect:function(obj){
				//发送 post 请求  then中第一个function或者箭头函数为success回调函数, 第二个function为失败fail回调函数
				this.$http.post('/ShengChanJiHua/getAllShengChanJiHua',{},{}).then((res)=>{
					this.planList=res.body;
					//this.planId=this.planList[0].planid;
					this.planId=obj;
				},(res)=>{
					console.log(res.status);
				});
			}
		}
	})



	var quxaio=(e)=>{
		var tr=$(e).parents("tr");
		var data=$("#mainContent").DataTable().row(tr).data();
		$.SmartMessageBox({
			title: "取消提示",
			content: "确认取消？",
			buttons: '[取消][确定]'
		}, function (ButtonPressed) {
			if (ButtonPressed === "确定") {
				myTool.mask.show('取消中...');
				$.ajax({
					type: 'POST',
					url:'/WhWasteMgn/updwarningState',
					dataType: 'json',
					data: {
						id:data.id,
						warningState:3,
					},
					success: function (json) {
						myTool.mask.hide();
						if(json!=0){
							data.warningstate=3;
							$('#mainContent').DataTable().row(tr).data(data);
							toastr.success('取消成功');
						}else{
							toastr.error('取消失败');
						}
					}
				});
			}
		});
	}

	function feiqi(obj){
		var tr=$(obj).parents("tr");
		var data=$("#mainContent").DataTable().row(tr).data();
		$.SmartMessageBox({
			title: "废弃提示",
			content: "确认废弃？",
			buttons: '[取消][确定]'
		}, function (ButtonPressed) {
			if (ButtonPressed === "确定") {
				myTool.mask.show('废弃中...');
				$.ajax({
					type: 'POST',
					url:'/WhWasteMgn/updwarningState',
					dataType: 'json',
					data: {
						id:data.id,
						warningState:1,
					},
					success: function (json) {
						myTool.mask.hide();
						if(json!=0){
							data.warningstate=1;
							$('#mainContent').DataTable().row(tr).data(data);
							toastr.success('废弃成功');
						}else{
							toastr.error('废弃失败');
						}
					}
				});
			}
		});
	}



</script>
</html>